# 定时器
定时器 （TIM，Timer）就是计数器
![[定时器结构简图.png]]
CCR （Capture/Compare Register，捕获/比较寄存器），用于输入捕获和输出比较
当在输入捕获模式时，输入信号的边沿（上升沿、下降沿或双边沿）被检测；或在输出比较模式时，计数器（CNT）值与捕获/比较寄存器（CCR）的值相等时，就会触发CCx事件，把标志TIM_FLAG_CCx置1，根据所选模式不同触发对应的回调函数
有阴影的代表存在对应的影子寄存器
影子寄存器的作用：若启用影子寄存器，在程序对参数进行写入的操作时，会先将数据写入到影子寄存器里，待到计数器走完一个完整周期后，在把该值赋给对应的原寄存器
![[通用定时器.png]]
## 时基单元

### 时基单元的结构
![[定时器时基单元的基本结构.png]]
### 时基单元的配置

Counter Setting计数器设置：
1. Prescaler：
	设置预分频器分频数PSC，设置为16-1时，频率除以16
2. Counter Mode：
	可以选择顺序计数(Up)、逆序计数(Down)、中心对齐计数(Center Aligned)，具体作用见图
3.  Counter Period：
	设置自动重装载寄存器ARR，设置为32-1时，每次计数器的数从0数到31时，就进行一次重装载，将使得频率除以32
4. Internal Clock Division(CKD)：
	 用于将定时器收到的时钟信号进一步分频，以供定时器内部单元的使用（尤其是滤波器和死区发生器）。当定时器时钟较高而输入信号频率较低时，可以适当分频提高滤波器稳定性
5. Repetition Counter：
	设置重复计数寄存器RCR，设置为2时，计数器CNT溢出三次以后，会产生一次update事件
6. Auto-Reload Preload：
	自动自动重装载寄存器预加载，可启用ARR的影子寄存器
##  输出比较

指用比较的方式从定时器输出信号，常用于PWM(Pulse Width Modulation，脉宽调制)
### 输出比较的结构
![[定时器输出比较结构简图.png]]
其中CHx和CHxN的输出互补
### 输出比较的配置
Output Channel x：
1.  Mode：选择输出比较模式
	1. Frozen：冻结，保持不变
	2. Active Level On Match：当CNT=CCR时输出高电平，否则输出低电平
	3. Inactive Level On Match：当CNT=CCR时输出低电平，否则输出高电平
	4. Toggle On Match：翻转，每当CNT=CCR时就翻转一次电压
	5. Force Active：强制有效，强制高电平
	6. Force Inactive：强制无效，强制低电平
2.     Pulse：设置CCR的值
3.     Polarity：极性，High为正常输出，Low为反向输出
4.     CH Idle State：通道空闲时默认输出的电平（如Frozen的时候）
![[定时器输出比较各模式的机制.png]]
##  输入捕获
指获取信号发生变化时的时间点，并保存
###  输入捕获的结构
![[定时器输入捕获结构简图.png]]

![[定时器输入捕获结构图.png]]
![[定时器输入捕获机制图解.png]]
### 输入捕获的过程
1. 输入滤波：去除高频干扰
2. 边沿检测：当产生上升沿或下降沿脉冲时，进行检测
3. 信号选择：直接模式代表直接从本通道获取检测数据（如上图CH1），间接模式代表从本通道绑定的副通道获取检测数据（如上图CH2），TRC表示从从模式输入
4. 分频：进行分频，当触发几次信号时，触发CCx事件，这个时候计数器的值会被拍照保存到CCR寄存器中
###  输入捕获的配置
Input Channel x：
1.  Polarity Selection：设置捕获的信号为上升沿/下降沿
2.  IC Selection：设置信号输入来源直接/间接
3.  Prescaler Division Ratio：设置分频系数
4. Input Filter：设置输入滤波器的滤波能力（0~15）
## 从模式控制器

### 定时器的主从结构
![[定时器主从模式图解.png]]
![[定时器主从模式输入输出.png]]
TRGI （Trig Input）触发输入
TRGO （Trig Output）触发输出
### 作为主机TRGO配置
TRGO parameter：
1.     Master/Slave Mode(MSM bit)主/从模式：在使用多个计时器协调工作时，主计时器通过TRGO接入到从定时器的TRGI控制从定时器，同时从定时器自身的TRGI可能还接了其他的触发信号
	*1.1*. Disable(Trigger input effect not delayed)：，若选择此选项，从定时器在接收到触发信号时将立即响应，而不会等待主计时器的命令
	*1.2*. Enable(Trigger delayed for master/slaves simultaneous start)：若选择此选项，被该主定时器控制的所有从定时器在接收到触发信号时，会等待主定时器也输出TRGO之后再统一响应
2.     Trigger Event Selection触发事件选择：
	*2.1*. Reset(UG bit from TIMx_EGR)：只有在通过软件设置 TIMx_EGR.UG=1 时，才会产生一个TRGO
	*2.2*. Enable (CNT_EN)：当定时器 TIMx_CR1.CEN 由0变1，也就是定时器启动的时候
	*2.3*. Update Event：每次定时器溢出时（UG或者ARR重装时），发出一个TRGO
3. Compare Pulse (OC1)：当通道 1 处于 PWM mode 1/2，且 CCR1 = CNT 时，产生一个脉冲型 TRGO（1个周期宽度）
4. Output Compare (OCxREF)：将OCxREF作为TRGO输出，OCxREF就是通道x经过输出比较输出的电平，不过相比OCx没有经过CH Polarity极性选择的处理
### 编码器模式原理
增量型旋转编码器会输出A相和B相两道信号，两道信号之间有90度的相差，据此可以判断旋钮是顺时针还是逆时针旋转。
![[增量型旋转编码器.png]]
将A相与B相信号分别接入TI1FP1和TI2FP2（TI1FP1表示Timer Input1 Filtered Polarized 1，表示从通道1进入，经过滤波和边缘检测，然后从通道1输出(即直接模式)，TI2FP2以此类推）
![[定时器的三种编码器模式.png]]
这样，模式3记下的数是模式1和模式2的两倍，模式1和模式2只是时间有差异
### 编码器模式配置
在Combined Channels设置Encoder Mode
1. Encoder Mode：编码器模式
	1. Encoder Mode TI1编码器模式1：仅在A相边沿计数
	2. Encoder Mode TI2编码器模式2：仅在B相边沿计数
	3. Encoder Mode TI3编码器模式3：双相边沿计数，即既在A相边沿计数，也在B相边沿计数
2. Polarity Selection：设置捕获的信号为上升沿/下降沿
3. IC Selection：设置信号输入来源直接/间接
4. Prescaler Division Ratio：设置分频系数
5. Input Filter：设置输入滤波器的滤波能力（0~15）
### 1.1.2 从模式配置
1. Slave Mode从模式：
	*1.1.* External Clock Mode 1外部时钟模式1：以外部时钟信号作为时钟源，需要选择一个触发源
	*1.2.* Reset Mode复位模式：当TRGI输入一个上升沿时，计时器的CNT将清零，并产生一个update事件
	*1.3.* Gated Mode门模式：当TRGI输入高电平时，计时器开始计数；当TRGI输入低电平时，计时器停止计数，保持原来的CNT不变
	*1.4.* Trigger Mode触发模式：当TRGI输入一个上升沿时，计时器被启动并开始计数
2. Trigger Source触发源：
	*2.1.* ITRx (Internal Triggerx)：从该计时器以外的其他计时器获取触发，具体是哪个计时器要参考手册
	*2.2.* ETR1(External Trigger1)：从外部端口获取触发
	*2.3.* TI1_ED(Timer Input1_Edge Detect)：从CH1通道输入并经滤波、边沿检测得到的双边沿检测脉冲信号
	*2.4.* TI1FP1(Timer Input1 Filtered Polarized)：从CH1通道输入并经滤波、边沿检测得到的单边沿检测脉冲信号
3. Clock Source时钟源：
	*3.1.* Internal Clock：定时器时钟选用内部时钟
	*3.2.* ETR2(External Trigger2)：从外部端口获取时钟（注：若Slave Mode设置为External Clock, Trigger Source设置为ETR1时，实现的功能和Clock Source设置为ETR2是一样的）
4. Channels诸通道：
	*4.1.* Input Capture Direct：输入捕获直接模式
	*4.2.* Input Capture Indirect：输入捕获间接模式
	*4.3.* Input Capture Trigged by TRC：在TRC(Trigger Controller有效时才能实现捕获，其中TRC何时有效取决于Slave Mode的设置。当处于External Clock Mode 1时，TRC在TRGI 边沿事件发生后的一瞬间有效；当处于Reset Mode时，TRC在TRGI边沿发生瞬间有效，同时CNT要清零；当处于Gated Mode时，TRC在TRGI有效期间（如高电平）有效。
	*4.4.* Output Compare No Output：输出比较无输出
	*4.5.* Output Compare CHx：输出比较普通输出
	*4.6.* Output Compare CHxN：输入比较反向输出
	*4.7.* Output Compare CHx CHxN：输入比较既输出正向又输出反向
	*4.8.* PWM Generation No Output：脉宽调制生成无输出
	*4.9.* PWM Generation CHx：脉宽调制生成普通输出
	*4.10.* PWM Generation CHxN：脉宽调制生成反向输出
	*4.11.* PWM Generation CHx CHxN：脉宽调制生成既输出正向又输出反向
	*4.12.* Force Output No Output：强迫输出无输出
	*4.13.* Force Output No Output：强迫输出无输出
	*4.14.* Force Output CHx：强迫输出普通输出
	*4.15.* Force Output CHxN：强迫输出反向输出
	*4.16.* Force Output CHx CHxN：强迫输出既输出正向又输出反向
5. Combined Channels混合通道：
	*5.1.* Encoder Mode：编码器模式
	*5.2.* PWM Input On CH1：在CH1进行PWM输入捕获，启用此设置时，Cube MX会自动将CH1设置为直接模式，上升沿捕获；CH2自动配置为简洁模式，下降沿捕获；Slave Mode自动设置为Reset Mode，当CH1检测到上升沿时，会触发ARR自动重装载。由此可通过CH1的捕获结果轻易测出周期，通过CH2的捕获结果轻易测出占空比。
	*5.3.* PWM Input On CH2：和上面一样，只不过CH1和CH2的角色互换
	*5.4.* XOR ON/Hall Sensor Mode：……
Ex.
	One Pulse Mode：单触发模式，触发之后，只执行一次计数周期，然后自动停止计时器