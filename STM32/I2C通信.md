# I2C通信
## I2C的结构
$\qquad$I2C（Inter-Integrated Circuit）可以利用一根时钟线（SCL）和一根数据线（SDA），使得一个主机能够与连接总线的多个器件之间进行信息传递的通信方式。

![[IIC总线结构简图.png]]

SCL （Serial Clock）：串行时钟线，负责传输时钟信号
SDA （Serial Data）：串行数据线，负责传输数据
SCL和SDA都需要通过一个上拉电阻上拉
主机和从机连接到SCL和SDA引脚的方式都应该使用开漏输出
默认情况下，主机和从机的端口都为高阻态，经过上拉，总线上为高电平
当某个端口输出低电平时，总线上就会输出低电平
## I2C协议
I2C的通信过程包括：
$$
起始信号 → 从机地址码和读/写位 → 从机应答 → 数据内容 → 从机/主机应答 → 停止信号
$$
1. 起始阶段：
	主机发送一个下降沿，拉低SDA，宣布通信开始。
2. 地址码和读/写位：
	在I2C通信中，每一个从机设备都对应一个地址码，地址码有7位和10位的，这里只讨论7位的。
	7位地址码一般用十六进制数储存，比如地址为0x3C(0011 1100)，最终发送的地址码是该数字的后7位数。
	地址位后紧跟着的是读写位，主机向从机写数据时，此位为1；主机从从机读数据时，此位为0。结合起来，若写数据，此8位发送`0x3C << 1 | 0（01111000）`；若读数据，此8位发送`0x3C << 1 | 1（01111001）`。
3. 从机应答：
	当从机收到地址码和读写位信号时，对应地址的从机会发送一个应答信号ACK，拉低SDA，以表明从机收到命令。
	若此时从机没有应答，可能原因是地址错误、从机不存在、从机损坏、从机繁忙。
4. 数据内容：
	根据此时是读操作还是写操作，这时会8位8位地在SDA上传输数据
5. 从机/主机应答：
	若此时是写操作，当主机向从机传输完数据之后，从机会发送一个ACK信号代表写入完毕。
	若此时是读操作，当从机向主机传输完8位数据之后，主机会向从机发送一个ACK表示“收到，请继续”。
6. 停止信号
	若此时是写操作，当写入完毕后，主机会上拉SDA，宣布此次通信完毕。
	若此时是读操作，当读数据结束时，主机会上拉SDA，宣布此次通信完毕。
![[IIC通信协议.png]]
## I2C的配置
包含两栏参数，主机特性Master Features是单片机做主机时的参数，从机特性Slave Features是单片机做从机时的参数。
### 主机特性
- 速度模式Speed Mode：表示I2C数据传输的速度，标准模式≤100kbps，快速模式≤400kbps
- 时钟速度Clock Speed：表示SCL的脉冲速度，只能设置在对应速度模式范围内的速度
- 快速模式占空比Fast Mode Duty Cycle：开启快速模式才有的选项，可以设置SCL的占空比
### 从机特性
- 时钟无拉伸模式Clock No Stretch Mode：在某些情况下，从设备可能需要更多时间来处理数据，此时它可以通过将SCL线拉低来暂停传输，直到准备好继续传输为止。启用这一项时会禁用该功能
- 选择设备主地址长度Primary Address Length selection：选择单片机作为从机时的地址是7位或10位
- 双地址确认Dual Address Acknowledge：允许单片机相应两个不同的地址
- 从机主地址Primary Slave Address：单片机作为从机时的主地址（需要左移一位才能变成7位的那个地址）
- 通用呼叫地址检测General Call Address Detection：当主机向通用呼叫地址（一般是0x00）发送数据时，所有启用了这项的从机都能收到来自主机的广播信息